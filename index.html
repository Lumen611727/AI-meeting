<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Google Meet Chat Add-on</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  body { font-family: Arial; padding:12px; background:#fafafa; }
  #status { font-size:12px; margin-bottom:6px; color:#666; }
  #messages { height:280px; overflow:auto; border:1px solid #ddd; padding:8px; background:white; margin-bottom:10px; }
  .msg { margin:6px 0; padding:6px; border-radius:6px; max-width:80%; }
  .me { background:#d8f7e8; margin-left:auto; }
  .other { background:#ececec; margin-right:auto; }

  #composer { display:flex; gap:6px; }
  input { flex:1; padding:8px; border-radius:6px; border:1px solid #ccc; }
  button { padding:8px 14px; border-radius:6px; border:none; background:#409eff; color:white; }
</style>

<script src="https://www.gstatic.com/meetjs/addons/1.1.0/meet.addons.js"></script>
<script type="module">

/* -------------------------------------------------
 ðŸ”¥ éœ€è‡ªè¡Œæ›¿æ› (Firebase å°ˆæ¡ˆ)
---------------------------------------------------*/
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
};

/* -------------------------------------------------
 ðŸ”¥ å¿…å¡« (Google Cloud Project Number)
 âš ï¸ æ²’å¡«æœƒç›´æŽ¥å ± 401
---------------------------------------------------*/
const CLOUD_PROJECT_NUMBER = "YOUR_GCP_PROJECT_NUMBER"; // â† è¦æ”¹

/* ----------------- Firebase ------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } 
from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ----------------- UI Elements ---------------- */
const statusEl   = document.getElementById("status");
const messagesEl = document.getElementById("messages");
const inputEl    = document.createElement("input");
const sendBtn    = document.createElement("button");

sendBtn.textContent = "ç™¼é€";

/* ----------------- å»ºç«‹ Add-on Session ---------------- */
async function initMeetContext() {
  try {
    const session = await meet.addon.createAddonSession({
      cloudProjectNumber: "504590536903"
    });

    const client = session.createSidePanelClient();

    const meeting = await client.getMeeting();
    const user    = await client.getLocalParticipant();

    return {
      meetingId: meeting.meetingId,
      userName:  user.displayName || "æœªçŸ¥ä½¿ç”¨è€…"
    };
  } catch (e) {
    alert("â— Add-on æœªåœ¨ Google Meet å…§åŸ·è¡Œ\nè«‹å…ˆå¾ž Meet åŠ è¼‰å¤–æŽ›");
    throw e;
  }
}

/* ----------------- ä¸»è¦å•Ÿå‹• ---------------- */
(async () => {
  const { meetingId, userName } = await initMeetContext();

  statusEl.textContent = `æœƒè­°ï¼š${meetingId}ï½œä½¿ç”¨è€…ï¼š${userName}`;

  const roomRef = collection(db, "rooms", meetingId, "messages");
  const q = query(roomRef, orderBy("ts"));

  onSnapshot(q, snap => {
    messagesEl.innerHTML = "";
    snap.forEach(d => {
      const msg = d.data();
      const el = document.createElement("div");
      el.className = "msg " + (msg.user===userName ? "me":"other");
      el.innerHTML = `<b>${msg.user}</b><br>${msg.text}`;
      messagesEl.appendChild(el);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

  sendBtn.onclick = async () => {
    const txt = inputEl.value.trim();
    if (!txt) return;
    inputEl.value = "";
    addDoc(roomRef, {
      user: userName,
      text: txt,
      ts: Date.now()
    });
  };

})();

document.body.appendChild(statusEl);
document.body.appendChild(messagesEl);
document.body.appendChild(Object.assign(document.createElement("div"),{
  id:"composer",
  appendChild(){ this.append(inputEl,sendBtn); return this }
}).appendChild());

</script>
</head>
<body></body>
</html>
